# Веб-поиск в чате

## Описание

Добавлена функциональность автоматического веб-поиска в чат-систему. Теперь ИИ может определять, когда для ответа на вопрос пользователя нужна актуальная информация из интернета, и автоматически выполнять поиск.

## Как это работает

### 1. Определение необходимости поиска

Система анализирует вопрос пользователя и определяет, нужен ли веб-поиск для получения актуальной информации.

**Веб-поиск НУЖЕН для:**
- Погоды (текущая погода, прогноз)
- Новостей (актуальные события, последние новости)
- Курсов валют (текущие курсы)
- Цен на товары/услуги
- Расписания транспорта
- Информации о событиях, концертах, фильмах
- Статистики (спорт, экономика, политика)
- Любой информации, которая может измениться со временем

**Веб-поиск НЕ НУЖЕН для:**
- Общих знаний (история, наука, факты)
- Объяснений понятий
- Советов и рекомендаций общего характера
- Математических расчетов
- Личных вопросов

### 2. Выполнение поиска

Если система определяет, что нужен поиск:
1. Формируется поисковый запрос на русском языке
2. Выполняется запрос к Google Search API через Serper
3. Результаты обрабатываются ИИ для формирования ответа
4. Пользователь получает ответ на основе найденной информации

### 3. Интеграция в чат

Функциональность интегрирована в:
- **WebSocket чат** (`/chat/websocket`) - для текстовых сообщений
- **Голосовой WebSocket** (`/websocket-voice`) - для голосовых команд

## Настройка

### Переменные окружения

Добавьте в ваш `.env` файл:

```env
SERPER_API_KEY=your_serper_api_key_here
```

### Получение API ключа Serper

1. Зарегистрируйтесь на [serper.dev](https://serper.dev)
2. Получите API ключ
3. Добавьте ключ в переменные окружения

## Примеры использования

### Текстовый чат

```
Пользователь: "Какая погода в Москве?"
Система: "Ищу актуальную информацию..."
Система: "В Москве сегодня +15°C, облачно с прояснениями. Ожидается дождь к вечеру."

Пользователь: "Курс доллара к рублю"
Система: "Ищу актуальную информацию..."
Система: "Текущий курс доллара к рублю: 95.42 рубля за доллар США."
```

### Голосовой чат

```
Пользователь: "Какие новости в Казахстане?"
Система: [озвучивает] "Ищу актуальную информацию..."
Система: [озвучивает] "Основные новости Казахстана сегодня: [актуальная информация]"
```

## Тестирование

Запустите тестовый файл для проверки функциональности:

```bash
python test_web_search.py
```

## Файлы изменений

### Новые функции в `app/services/voice.py`:
- `needs_web_search()` - определяет необходимость поиска
- `process_web_search_results()` - обрабатывает результаты поиска

### Изменения в `app/core/dependencies.py`:
- `handle_web_search()` - сделана асинхронной
- Добавлена логика веб-поиска в голосовой WebSocket

### Изменения в `app/routers/chat.py`:
- Добавлена логика веб-поиска в текстовый WebSocket чат

## Обработка ошибок

Система корректно обрабатывает:
- Отсутствие API ключа
- Ошибки сети
- Недоступность поискового сервиса
- Некорректные ответы от API

В случае ошибок пользователь получает понятное сообщение об ошибке.

## Производительность

- Поиск выполняется асинхронно
- Добавлено промежуточное сообщение "Ищу актуальную информацию..." для лучшего UX
- Результаты кэшируются в рамках одной сессии
- Таймауты настроены для предотвращения зависания

## Безопасность

- API ключи хранятся в переменных окружения
- Поисковые запросы логируются для отладки
- Ограничения на размер ответов от поискового API 